# Car Puzzle Solver using Z3 (SMT)

This repository contains a **grid-based car puzzle solver** implemented in **Python** using the **Z3 SMT solver**.  
The project focuses on **constraint modeling**, **bounded planning**, and **SMT-LIB2 generation**.

The solver supports:
- Validation of puzzle instances
- Solving puzzles with a **minimal number of moves**
- Random puzzle generation
- Export of the corresponding **SMT-LIB2 formulas**

---

## Repository Structure

```bash
├── README.md
├── outputs
│   ├── model_dump_T0.smt2
│   ├── model_dump_T1.smt2
│   ├── model_dump_T2.smt2
│   ├── model_dump_T3.smt2
│   ├── model_dump_T4.smt2
│   ├── model_dump_T5.smt2
│   ├── model_dump_T6.smt2
│   ├── model_dump_T7.smt2
│   └── model_dump_T8.smt2
├── results.txt
└── src
    ├── car_puzzle.py
    ├── manual_puzzle0.txt
    ├── manual_puzzle1.txt
    ├── manual_puzzle2.txt
    ├── puzzle_invalid_P_not_col0_5x5.txt
    ├── puzzle_invalid_goal_not_lastcol_5x5.txt
    ├── puzzle_invalid_no_goal_5x5.txt
    ├── puzzle_invalid_noncontiguous_5x5.txt
    ├── puzzle_invalid_same_row_horizontal_5x5.txt
    ├── puzzle_invalid_two_goals_5x5.txt
    ├── puzzle_invalid_uppercase_vertical_5x5.txt
    ├── puzzle_sat_1move_2x2.txt
    ├── puzzle_sat_1move_5x5.txt
    ├── puzzle_sat_obstacle_6x6.txt
    └── puzzle_solved_5x5.txt
```

- `README.md`  
  Project description and usage instructions.

- `results.txt`  
  Contains all execution results and solver outputs produced during development.

- `src/`  
  Main working directory:
  - `car_puzzle.py` – puzzle solver and random generator
  - `.txt` files – manual puzzle instances (valid, invalid, SAT, UNSAT-within-bound)
  - `outputs/` – SMT-LIB2 encodings generated by Z3

---

## Puzzle Description

The puzzle is played on an **N × N grid**.

Each cell contains one of the following symbols:

| Symbol | Meaning |
|------|--------|
| `X` | Empty cell |
| `Z` | Goal (exit) cell |
| `P` | Main car (horizontal, length 1, starts in column 0) |
| `p` | Main car (vertical, length 1, starts in row 0) |
| `A, B, C, ...` | Horizontal obstacle cars |
| `a, b, c, ...` | Vertical obstacle cars |

### Example

```bash
X B B X X
X X b X X
P X b X Z
X X X X X
A A A X X
```



---

## Validation Rules

Before solving, each puzzle is validated according to the following rules:

- The board must be **square**
- Exactly **one goal cell (`Z`)**
- Exactly **one main car (`P` or `p`)**
- Each car must be **contiguous** and aligned in a single row or column
- Uppercase letters represent **horizontal cars**
- Lowercase letters represent **vertical cars**
- The goal must be:
  - on the **last column** for a horizontal main car
  - on the **last row** for a vertical main car
- No other car may share the **main car’s lane** (same row or column)

Invalid puzzles are rejected with a clear error message.

---

## Solving Approach (Overview)

The problem is modeled as a **bounded planning** task:

- Each car has symbolic variables representing its **head position** at each time step
- Constraints enforce:
  - board boundaries
  - legal movement (+/- 1 cell or stay)
  - collision avoidance between all car segments
  - optionally, **exactly one car moves per step**
- A goal constraint requires the main car to reach the exit cell at time `T`

To obtain a minimal solution:
- The solver tries `T = 0, 1, 2, ...`
- The first satisfiable horizon is guaranteed to be minimal

---

## Running the Solver

All commands should be executed **from inside the `src/` directory**.

### Solve using GUI
```bash
python3 car_puzzle.py
```

### Solve a Manual Puzzle (without GUI)

```bash
python3 car_puzzle.py --file manual_puzzle1.txt --maxT 10
```

### Generate a Random Puzzle (without GUI)
```bash
python3 car_puzzle.py --generate --maxT 10
```

### Commands
| Command-Line | Description |
|------|--------|
| `--file FILE` | Solve a specific puzzle file |
| `--generate` | Generate a random puzzle |
| `--maxT N` | Maximum number of moves to search |
| `--idle-ok` | Allow steps where no car moves |
| `--dump-smt2` | Export SMT-LIB2 encoding to outputs/ |


Example with SMT-LIB2 export:
```bash
python3 car_puzzle.py --file puzzle_sat_obstacle_6x6.txt --maxT 8 --dump-smt2
```

### Results
All solver runs, example executions, and validation tests are recorded in:
`results.txt`

#### This includes:
-Random puzzle generation examples

-Valid and invalid puzzle tests

-Trivial and non-trivial SAT instances

-SMT-LIB2 generation and direct Z3 execution


#### Notes
-Random generation may produce puzzles that are valid but require more moves than the chosen maxT

-Such cases can be analyzed by increasing maxT and inspecting the generated SMT-LIB2 files

-SMT-LIB2 export is intended to support debugging and formal inspection of the model
